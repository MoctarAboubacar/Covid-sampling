---
title: "Probability sampling for phone interviews in COVID-19 times"
author: "Moctar Aboubacar"
date: "4/9/2020"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float: true
    theme: flatly
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here is an interesting problem that came across my desk recently which required a little thinking and some great use of R. This is precisely the kind of problem for which R is useful and where a little automation can go a long way and improve on working manually through Excel.

Under the COVID-19 response, phone surveys have become the preferred way to collect household information in developing country contexts. Computer-Assisted Telephone INterviews (CATI) are nothing new, but they [have been getting a re-examination](https://blogs.worldbank.org/impactevaluations/mobile-phone-surveys-understanding-covid-19-impacts-part-i-sampling-and-mode) as organizations scramble to gather data on the impacts of the developing COVID crisis.

This is the case for my organization. However we do not have access to a sampling frame of phone numbers from the country and have decided to go with random digit dialing as a way to get a sample. Thankfully we have some basic data to work with: 
1. The first digits of phone numbers, by telecom provider (zone codes)
2. The list of geographical zones to which each code corresponds
3. The proportion of phones registered under each telecom provider
4. The proportion of pre-and post-paid phone numbers

Using this information, we can generate a probability sample of phone numbers, ensuring that each number has an equal chance of being selected (and so allowing us, theoretically, to do proper inference in the household survey)

# Data

We have two datasets here: a list of phone numbers' first five digits (phone numbers in Nepal normally have 10), the zone each set of digits corresponds to, whether the digits are pre- or post-paid, and which telecom provider they belong to.
```{r, echo = FALSE, message = FALSE}
# clear
rm(list = ls())

# packages
require(tidyverse)
require(openxlsx)
require(kableExtra)
```
```{r}
# data
df <- read.csv("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/mVAM/Study design/Phone numbers first digits.csv")
df$number <- as.character(df$number)
df$zone_num <- as.factor(df$zone_num)
head(df) %>% 
kable() %>% 
  kable_styling("striped", position = "left", full_width = F)
```

# Generating a sampling frame

We have the front digits, and so need to generate the end 5 digits, to then combine the two into a viable phone number. To ensure we are including all the numbers (and that each number has an equal chance of being selected) I just generate ALL the numbers. There are $N^\alpha$ combinations of numbers possible where $N$ is the number of possible digits in one slot and $\alpha$ is the number of slots. In this case we have $10^5 = 100,000$ possible end-numbers for each of the front digits.  We combine all possible combinations of numbers for each row in our dataframe: this will be the sampling frame.

The code here may or may not be the most efficient way of doing things, but we are not dealing with so many numbers that it slows anything down, so I'm satisfied.

```{r}
# create possible end digits
vec <- as.character(1:100000)
vec <- str_pad(vec,
               side = "left",
               width = 5,
               pad = "0")
# create frame
all_num <- function(df, vec){
  mat <- matrix(ncol = length(df$number),
              nrow = length(vec))
for (i in 1:nrow(df)) {
  temp <- paste0(df$number[i], vec)
  mat[,i] <- temp }
return(mat) }
numbers <- all_num(df, vec)
```


# Sampling

One of our datasets has the sample needed for each combination of zone, telecom provider and pre-postpaid number.
```{r, echo=FALSE}
key <- read.csv("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/mVAM/Study design/sample size by type.csv")
```
```{r}
head(key) %>% 
kable() %>% 
  kable_styling("striped", position = "left", full_width = F)# 263 numbers are needed from Bagmati-NCell-prepaid phones
```

I use this dataset as a reference for which sample to take. I first define a matrix along dimensions specific to a particular zone, then generate random samples of the right size making reference to the 'key' dataset, for each combination of phone number types. These random samples are then randomly mixed and combined randomly into a vector in the matrix. I do this 10 times for each zone, and then iterate over all the 14 zones in the dataset, sampling from the frame created above.
```{r}
# sample according to design
key <- read.csv("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/mVAM/Study design/sample size by type.csv")

zone_sims <- function(zone = "Bagmati"){

matree <- matrix(ncol = 10,
                 nrow = (as.integer(key[key$zone == zone & key$type == "NT" & key$prepost == "pre",][5]) + as.integer(key[key$zone == zone & key$type == "NT" & key$prepost == "post",][5]) + as.integer(key[key$zone == zone & key$type == "Ncell" & key$prepost == "pre",][5]) + as.integer(key[key$zone == zone & key$type == "Ncell" & key$prepost == "post",][5])))

for (i in 1:10) {
v1 <- sample(numbers[,which(df$zone == zone & df$type == "NT" & df$prepost == "pre")],
             size = as.integer(key[key$zone == zone & key$type == "NT" & key$prepost == "pre",][5]))

v2 <- sample(numbers[,which(df$zone == zone & df$type == "NT" & df$prepost == "post")],
             size = as.integer(key[key$zone == zone & key$type == "NT" & key$prepost == "post",][5]))

v3 <- sample(numbers[,which(df$zone == zone & df$type == "Ncell" & df$prepost == "pre")],
             size = as.integer(key[key$zone == zone & key$type == "Ncell" & key$prepost == "pre",][5]))

v4 <- sample(numbers[,which(df$zone == zone & df$type == "Ncell" & df$prepost == "post")],
             size = as.integer(key[key$zone == zone & key$type == "Ncell" & key$prepost == "post",][5]))

matree[,i] <- sample(c(v1, v2, v3, v4)) }
matree }

# construct list of matrices of results
matList <- map(levels(df$zone), zone_sims)
names(matList) <- levels(df$zone)
```
Why 10 times? Because of non-response. Non-response could be for a host of reasons, but with random digit dialing I anticipate noonexistent phone numbers, disconnected numbers and non-individual numbers (businesses, etc.) to take up a large part of the numbers in the frame. As these will be skipped, enumerators need to have fallback numbers. generating 'only' ten times the expected number needed is actually maybe not advisable; but this can be scaled up to 20x, 100x by tweaking one number, so it's not a large concern at this stage. The first two days of data collection will determine if additional numbers need to be added here, and about how many.

# Saving to Excel

As these files need to be gotten over to enumerators, we need to save them to excel, each in a different sheet inside the same workbook. Packages like openxlsx and xlsx work well in this case. ([Emil BeBri](https://stackoverflow.com/questions/27524472/list-of-data-frames-to-individual-excel-worksheets-r)'s answer here was a lifesaver, and the openxlsx package has some great functionalities that need further exploring!). After this step the data are ready to be handed over to each enumerator.
```{r, eval=FALSE}
# save to excel file in 3 steps
# 1 create workbook
numbers <- createWorkbook()
# 2 iterate with anonymous function inside Map())
Map(function(matList, nameofsheet){     
  addWorksheet(numbers, nameofsheet)
  writeData(numbers, nameofsheet, matList)
}
matList, names(matList))

# 3 save workbook to excel file 
saveWorkbook(numbers, file = "C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/mVAM/Study design/numbers.xlsx", overwrite = TRUE)
```

# Considerations

There are several important points to consider here  
* We are generally okay with there being non-existent / non-reachable / non-applicable numbers within the frame, as they are passed over. It takes more time but does not affect our probability sampling.  
* We don't know the total # of connected phones in the country or the # of ppl or *who* has more than 1 phone. As a result not every phone-owning person has an exactly equal chance of being selected.  
* Response rates are anticipated to be low, [as research from other countries](https://blogs.worldbank.org/impactevaluations/mobile-phone-surveys-understanding-covid-19-impacts-part-ii-response-quality-and) suggests. Varying call times, offering incentives (which we plan on doing), having super-short introductions and other steps will help to raise the response rate.  
* In the end, the perfect is the enemy of the good-enough. We really need information on the effect of COVID-related lockdownd and movement stoppages on vulnerable populations, and this survey is expected to be a great step in that direction.